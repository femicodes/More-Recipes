'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.deleteRecipe = exports.modifyRecipe = exports.createRecipe = exports.getRecipes = exports.getRecipe = undefined;

var _models = require('../models');

var _models2 = _interopRequireDefault(_models);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Recipe = _models2.default.Recipe,
    Review = _models2.default.Review,
    User = _models2.default.User;

// Get data on a recipe
// GET ---> recipes

var getRecipe = exports.getRecipe = function getRecipe(req, res) {
	var recipeId = parseInt(req.params.recipeId);
	return Recipe.find({
		where: { id: recipeId },
		include: [{ model: Review, as: 'reviews', attributes: ['id', 'body', 'userId'] }]
	}).then(function (recipe) {
		if (recipe) res.status(200).json({ success: true, recipe: recipe });else res.status(200).json({ success: true, message: 'recipe does not exist' });
	}).catch(function (err) {
		return res.status(404).json({
			success: false,
			message: err
		});
	});
};

// query ---> start=10, end=20; sort=upvotes&order=ascending
var getRecipes = exports.getRecipes = function getRecipes(req, res) {
	var _req$query = req.query,
	    sort = _req$query.sort,
	    order = _req$query.order;


	if (sort && order) {

		// if sort and order exist convert them to lowercase ! 
		sort = sort.toLowerCase();
		order = order.toLowerCase();

		if (sort !== 'upvotes' && sort !== 'downvotes') return res.status(400).json({ success: false, message: 'Cannot sort recipes by ' + sort });

		if (order !== 'ascending' && order !== 'descending') return res.status(400).send({ success: false, message: 'Invalid order, Please use either ascending or descending' });

		var orderCriteria = order === 'ascending' ? 'ASC' : 'DESC';
		var sortCriteria = sort === 'upvotes' ? 'upvoteCount' : 'downvoteCount';

		// else if the order and sort is okay. ! 
		return Recipe.findAll({
			// attributes: ['id', 'title', 'description', 'ingredient', 'direction', 'upvoteCount', 'downvoteCount'],
			order: [[sortCriteria, orderCriteria]],
			include: [{ model: Review, as: 'reviews', attributes: ['id', 'body', 'userId'] }, { model: User, attributes: ['id', 'username', 'fullname'] }]
		}).then(function (recipes) {
			var recipeCount = recipes.length;
			if (recipeCount === 0) return res.status(200).send({ success: true, message: 'No recipes found' });
			res.status(200).send({ success: true, message: recipeCount + ' recipes found', recipes: recipes });
		}).catch(function () {
			return res.status(500).send({ success: false, message: 'cant get recipes' });
		});
	}

	// if no query passed, just return all the recipes 
	return Recipe.findAll({
		// attributes: ['id', 'userId', 'title', 'description', 'ingredient', 'direction', 'upvoteCount', 'downvoteCount'],
		order: [['upvoteCount', 'DESC']],
		include: [{ model: Review, as: 'reviews', attributes: ['id', 'body', 'userId'] }, { model: User, attributes: ['id', 'username', 'fullname'] }]
	}).then(function (recipes) {
		var recipeCount = recipes.length;
		if (recipeCount === 0) return res.status(200).send({ success: true, message: 'No recipes found' });
		res.status(200).send({ success: true, message: recipeCount + ' recipes found', recipes: recipes });
	}).catch(function (err) {
		return res.status(404).json({
			success: false,
			message: err.errors[0].message
		});
	});
};

// create a recipe 
var createRecipe = exports.createRecipe = function createRecipe(req, res) {
	var userId = req.userId;


	var title = req.body.title ? req.body.title.trim() : '';
	var description = req.body.description ? req.body.description.trim() : '';
	var ingredient = req.body.ingredient ? req.body.ingredient.trim() : '';
	var direction = req.body.direction ? req.body.direction.trim() : '';

	// console.log(userId)
	return Recipe.create({
		userId: userId,
		title: title,
		description: description,
		ingredient: ingredient,
		direction: direction
	}).then(function (recipe) {
		return res.status(201).json({ success: true, message: 'recipe created successfully', recipe: recipe });
	}).catch(function (err) {
		return res.status(500).json({ success: false, message: err });
	});
};

// modify a recipe
var modifyRecipe = exports.modifyRecipe = function modifyRecipe(req, res) {
	var userId = req.userId;
	var recipeId = req.params.recipeId;


	return Recipe.findById(recipeId).then(function (recipe) {
		if (recipe.userId !== userId) {
			return res.status(403).json({ success: false, message: 'Not authorized to modify this recipe!' });
		}
		return recipe.update({
			title: req.body.title || recipe.title,
			description: req.body.description || recipe.description,
			ingredient: req.body.ingredient || recipe.ingredient,
			direction: req.body.direction || recipe.direction
		}).then(function (recipe) {
			return res.status(200).json({ success: true, message: 'recipe updated successfully', recipe: recipe });
		}).catch(function () {
			return res.status(400).json({ success: false, message: 'Error modifying recipe' });
		});
	}).catch(function () {
		return res.status(500).json({
			success: false,
			message: 'Error modifying recipe!'
		});
	});
};

var deleteRecipe = exports.deleteRecipe = function deleteRecipe(req, res) {
	var userId = req.userId;
	// console.log(userId);

	Recipe.findById(req.params.recipeId).then(function (recipe) {
		if (recipe.userId !== userId) {
			return res.status(403).json({ success: false, message: 'Not authorized to delete this recipe' });
		}
		recipe.destroy().then(function () {
			return res.status(200).json({ sucess: true, message: 'Recipe deleted successfully' });
		}).catch(function () {
			return res.status(400).json({ success: false, message: 'Recipe cannot be deleted' });
		});
	}).catch(function () {
		return res.status(500).json({
			success: false,
			message: 'Error deleting recipe!'
		});
	});
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlY2lwZS5qcyJdLCJuYW1lcyI6WyJSZWNpcGUiLCJSZXZpZXciLCJVc2VyIiwiZ2V0UmVjaXBlIiwicmVxIiwicmVzIiwicmVjaXBlSWQiLCJwYXJzZUludCIsInBhcmFtcyIsImZpbmQiLCJ3aGVyZSIsImlkIiwiaW5jbHVkZSIsIm1vZGVsIiwiYXMiLCJhdHRyaWJ1dGVzIiwidGhlbiIsInJlY2lwZSIsInN0YXR1cyIsImpzb24iLCJzdWNjZXNzIiwibWVzc2FnZSIsImNhdGNoIiwiZXJyIiwiZ2V0UmVjaXBlcyIsInF1ZXJ5Iiwic29ydCIsIm9yZGVyIiwidG9Mb3dlckNhc2UiLCJzZW5kIiwib3JkZXJDcml0ZXJpYSIsInNvcnRDcml0ZXJpYSIsImZpbmRBbGwiLCJyZWNpcGVDb3VudCIsInJlY2lwZXMiLCJsZW5ndGgiLCJlcnJvcnMiLCJjcmVhdGVSZWNpcGUiLCJ1c2VySWQiLCJ0aXRsZSIsImJvZHkiLCJ0cmltIiwiZGVzY3JpcHRpb24iLCJpbmdyZWRpZW50IiwiZGlyZWN0aW9uIiwiY3JlYXRlIiwibW9kaWZ5UmVjaXBlIiwiZmluZEJ5SWQiLCJ1cGRhdGUiLCJkZWxldGVSZWNpcGUiLCJkZXN0cm95Iiwic3VjZXNzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7O0FBQUE7Ozs7OztJQUVRQSxNLG9CQUFBQSxNO0lBQVFDLE0sb0JBQUFBLE07SUFBUUMsSSxvQkFBQUEsSTs7QUFFeEI7QUFDQTs7QUFDTyxJQUFNQyxnQ0FBWSxTQUFaQSxTQUFZLENBQUNDLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQ3RDLEtBQU1DLFdBQVdDLFNBQVNILElBQUlJLE1BQUosQ0FBV0YsUUFBcEIsQ0FBakI7QUFDQSxRQUFPTixPQUNMUyxJQURLLENBQ0E7QUFDTEMsU0FBTyxFQUFDQyxJQUFJTCxRQUFMLEVBREY7QUFFTE0sV0FBUyxDQUFDLEVBQUVDLE9BQU9aLE1BQVQsRUFBaUJhLElBQUksU0FBckIsRUFBZ0NDLFlBQVksQ0FBQyxJQUFELEVBQU8sTUFBUCxFQUFl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QyxHQUN4QmxDLEdBRHdCLENBQ2xDa0MsTUFEa0M7QUFFekM7O0FBQ0F0QyxRQUNFK0MsUUFERixDQUNXM0MsSUFBSUksTUFBSixDQUFXRixRQUR0QixFQUVFVSxJQUZGLENBRVEsa0JBQVU7QUFDaEIsTUFBSUMsT0FBT3FCLE1BQVAsS0FBbUJBLE1BQXZCLEVBQStCO0FBQzlCLFVBQU9qQyxJQUFJYSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsRUFBQ0MsU0FBUyxLQUFWLEVBQWlCQyxTQUFTLHNDQUExQixFQUFyQixDQUFQO0FBQ0E7QUFDREosU0FDRWlDLE9BREYsR0FFRWxDLElBRkYsQ0FFUTtBQUFBLFVBQU1YLElBQUlhLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQixFQUFDZ0MsUUFBUSxJQUFULEVBQWU5QixTQUFTLDZCQUF4QixFQUFyQixDQUFOO0FBQUEsR0FGUixFQUdFQyxLQUhGLENBR1M7QUFBQSxVQUFNakIsSUFBSWEsTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLEVBQUNDLFNBQVMsS0FBVixFQUFpQkMsU0FBUywwQkFBMUIsRUFBckIsQ0FBTjtBQUFBLEdBSFQ7QUFJQSxFQVZGLEVBV0VDLEtBWEYsQ0FXUztBQUFBLFNBQU1qQixJQUFJYSxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUI7QUFDbENDLFlBQVMsS0FEeUI7QUFFbENDLFlBQVM7QUFGeUIsR0FBckIsQ0FBTjtBQUFBLEVBWFQ7QUFlQSxDQWxCTSIsImZpbGUiOiJyZWNpcGUuanMiLCJzb3VyY2VSb290IjoiQzovVXNlcnMvVG9iaS9Nb3JlLVJlY2lwZXMvc2VydmVyL2NvbnRyb2xsZXIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZGIgZnJvbSAnLi4vbW9kZWxzJztcclxuXHJcbmNvbnN0IHsgUmVjaXBlLCBSZXZpZXcsIFVzZXJ9ID0gZGI7XHJcblxyXG4vLyBHZXQgZGF0YSBvbiBhIHJlY2lwZVxyXG4vLyBHRVQgLS0tPiByZWNpcGVzXHJcbmV4cG9ydCBjb25zdCBnZXRSZWNpcGUgPSAocmVxLCByZXMpID0+IHtcclxuXHRjb25zdCByZWNpcGVJZCA9IHBhcnNlSW50KHJlcS5wYXJhbXMucmVjaXBlSWQpO1xyXG5cdHJldHVybiBSZWNpcGVcclxuXHRcdC5maW5kKHtcclxuXHRcdFx0d2hlcmU6IHtpZDogcmVjaXBlSWR9LCBcclxuXHRcdFx0aW5jbHVkZTogW3sgbW9kZWw6IFJldmlldywgYXM6ICdyZXZpZXdzJywgYXR0cmlidXRlczogWydpZCcsICdib2R5JywgJ3VzZXJJZCddIH1dLFxyXG5cdFx0fSlcclxuXHRcdC50aGVuKCByZWNpcGUgPT4ge1xyXG5cdFx0XHRpZiAocmVjaXBlKVxyXG5cdFx0XHRcdHJlcy5zdGF0dXMoMjAwKS5qc29uKHtzdWNjZXNzOiB0cnVlLCByZWNpcGV9KTtcclxuXHRcdFx0ZWxzZSBcclxuXHRcdFx0XHRyZXMuc3RhdHVzKDIwMCkuanNvbih7c3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ3JlY2lwZSBkb2VzIG5vdCBleGlzdCd9KTtcclxuXHRcdH0pXHJcblx0XHQuY2F0Y2goZXJyID0+IHJlcy5zdGF0dXMoNDA0KS5qc29uKHtcclxuXHRcdFx0c3VjY2VzczogZmFsc2UsXHJcblx0XHRcdG1lc3NhZ2U6IGVyclxyXG5cdFx0fSkpO1xyXG59O1xyXG5cclxuXHJcbi8vIHF1ZXJ5IC0tLT4gc3RhcnQ9MTAsIGVuZD0yMDsgc29ydD11cHZvdGVzJm9yZGVyPWFzY2VuZGluZ1xyXG5leHBvcnQgY29uc3QgZ2V0UmVjaXBlcyA9IChyZXEsIHJlcykgPT4ge1xyXG5cdGxldCB7c29ydCwgb3JkZXJ9ID0gcmVxLnF1ZXJ5O1xyXG5cclxuXHRpZiAoc29ydCAmJiBvcmRlcikge1xyXG5cclxuXHRcdC8vIGlmIHNvcnQgYW5kIG9yZGVyIGV4aXN0IGNvbnZlcnQgdGhlbSB0byBsb3dlcmNhc2UgISBcclxuXHRcdHNvcnQgPSBzb3J0LnRvTG93ZXJDYXNlKCk7IFxyXG5cdFx0b3JkZXIgPSBvcmRlci50b0xvd2VyQ2FzZSgpO1xyXG5cdFx0XHJcblx0XHRpZiAoc29ydCAhPT0gJ3Vwdm90ZXMnICYmIHNvcnQgIT09ICdkb3dudm90ZXMnKVxyXG5cdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDApLmpzb24oe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiBgQ2Fubm90IHNvcnQgcmVjaXBlcyBieSAke3NvcnR9YH0pO1xyXG5cdFx0XHJcblxyXG5cdFx0aWYgKG9yZGVyICE9PSAnYXNjZW5kaW5nJyAmJiBvcmRlciAhPT0gJ2Rlc2NlbmRpbmcnKVxyXG5cdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDApLnNlbmQoe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnSW52YWxpZCBvcmRlciwgUGxlYXNlIHVzZSBlaXRoZXIgYXNjZW5kaW5nIG9yIGRlc2NlbmRpbmcnfSk7XHJcblx0XHRcclxuXHJcblx0XHRcclxuXHRcdGNvbnN0IG9yZGVyQ3JpdGVyaWEgPSBvcmRlciA9PT0gJ2FzY2VuZGluZyc/ICdBU0MnIDogJ0RFU0MnO1xyXG5cdFx0Y29uc3Qgc29ydENyaXRlcmlhID0gc29ydCA9PT0gJ3Vwdm90ZXMnPyAndXB2b3RlQ291bnQnIDogJ2Rvd252b3RlQ291bnQnO1xyXG5cclxuXHRcdC8vIGVsc2UgaWYgdGhlIG9yZGVyIGFuZCBzb3J0IGlzIG9rYXkuICEgXHJcblx0XHRyZXR1cm4gUmVjaXBlXHJcblx0XHRcdC5maW5kQWxsKHtcclxuXHRcdFx0XHQvLyBhdHRyaWJ1dGVzOiBbJ2lkJywgJ3RpdGxlJywgJ2Rlc2NyaXB0aW9uJywgJ2luZ3JlZGllbnQnLCAnZGlyZWN0aW9uJywgJ3Vwdm90ZUNvdW50JywgJ2Rvd252b3RlQ291bnQnXSxcclxuXHRcdFx0XHRvcmRlcjogW1tzb3J0Q3JpdGVyaWEsIG9yZGVyQ3JpdGVyaWFdXSxcclxuXHRcdFx0XHRpbmNsdWRlOiBbXHJcblx0XHRcdFx0XHR7IG1vZGVsOiBSZXZpZXcsIGFzOiAncmV2aWV3cycsIGF0dHJpYnV0ZXM6IFsnaWQnLCAnYm9keScsICd1c2VySWQnXSB9LFxyXG5cdFx0XHRcdFx0eyBtb2RlbDogVXNlciwgYXR0cmlidXRlczogWydpZCcsICd1c2VybmFtZScsICdmdWxsbmFtZSddIH1cclxuXHRcdFx0XHRdXHJcblx0XHRcdH0pXHJcblx0XHRcdC50aGVuKHJlY2lwZXMgPT4ge1xyXG5cdFx0XHRcdGNvbnN0IHJlY2lwZUNvdW50ID0gcmVjaXBlcy5sZW5ndGg7XHJcblx0XHRcdFx0aWYgKHJlY2lwZUNvdW50ID09PSAwKSBcclxuXHRcdFx0XHRcdHJldHVybiByZXMuc3RhdHVzKDIwMCkuc2VuZCh7c3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ05vIHJlY2lwZXMgZm91bmQnfSk7XHJcblx0XHRcdFx0cmVzLnN0YXR1cygyMDApLnNlbmQoeyBzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOiBgJHtyZWNpcGVDb3VudH0gcmVjaXBlcyBmb3VuZGAsIHJlY2lwZXN9KTtcclxuXHRcdFx0fSlcclxuXHRcdFx0LmNhdGNoKCAoKSA9PiByZXMuc3RhdHVzKDUwMCkuc2VuZCh7c3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6ICdjYW50IGdldCByZWNpcGVzJ30pKTtcclxuXHR9XHJcblxyXG5cdC8vIGlmIG5vIHF1ZXJ5IHBhc3NlZCwganVzdCByZXR1cm4gYWxsIHRoZSByZWNpcGVzIFxyXG5cdHJldHVybiBSZWNpcGVcclxuXHRcdC5maW5kQWxsKHtcclxuXHRcdFx0Ly8gYXR0cmlidXRlczogWydpZCcsICd1c2VySWQnLCAndGl0bGUnLCAnZGVzY3JpcHRpb24nLCAnaW5ncmVkaWVudCcsICdkaXJlY3Rpb24nLCAndXB2b3RlQ291bnQnLCAnZG93bnZvdGVDb3VudCddLFxyXG5cdFx0XHRvcmRlcjogW1sndXB2b3RlQ291bnQnLCAnREVTQyddXSxcclxuXHRcdFx0aW5jbHVkZTogW1xyXG5cdFx0XHRcdHsgbW9kZWw6IFJldmlldywgYXM6ICdyZXZpZXdzJywgYXR0cmlidXRlczogWydpZCcsICdib2R5JywgJ3VzZXJJZCddIH0sXHJcblx0XHRcdFx0eyBtb2RlbDogVXNlciwgYXR0cmlidXRlczogWydpZCcsICd1c2VybmFtZScsICdmdWxsbmFtZSddIH1cclxuXHRcdFx0XVxyXG5cdFx0fSlcclxuXHRcdC50aGVuKHJlY2lwZXMgPT4ge1xyXG5cdFx0XHRjb25zdCByZWNpcGVDb3VudCA9IHJlY2lwZXMubGVuZ3RoO1xyXG5cdFx0XHRpZiAocmVjaXBlQ291bnQgPT09IDApIFxyXG5cdFx0XHRcdHJldHVybiByZXMuc3RhdHVzKDIwMCkuc2VuZCh7c3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ05vIHJlY2lwZXMgZm91bmQnfSk7XHJcblx0XHRcdHJlcy5zdGF0dXMoMjAwKS5zZW5kKHsgc3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogYCR7cmVjaXBlQ291bnR9IHJlY2lwZXMgZm91bmRgLCByZWNpcGVzfSk7XHRcclxuXHRcdH0pXHJcblx0XHQuY2F0Y2goIGVyciA9PiByZXMuc3RhdHVzKDQwNCkuanNvbih7XHJcblx0XHRcdHN1Y2Nlc3M6IGZhbHNlLFxyXG5cdFx0XHRtZXNzYWdlOiBlcnIuZXJyb3JzWzBdLm1lc3NhZ2VcclxuXHRcdH0pKTtcclxufTtcclxuXHJcblxyXG4vLyBjcmVhdGUgYSByZWNpcGUgXHJcbmV4cG9ydCBjb25zdCBjcmVhdGVSZWNpcGUgPSAocmVxLCByZXMpID0+IHtcclxuXHRjb25zdCB7dXNlcklkfSA9IHJlcTtcclxuXHRcclxuXHRsZXQgdGl0bGUgPSByZXEuYm9keS50aXRsZT8gcmVxLmJvZHkudGl0bGUudHJpbSgpIDogJyc7XHJcblx0bGV0IGRlc2NyaXB0aW9uID0gcmVxLmJvZHkuZGVzY3JpcHRpb24/IHJlcS5ib2R5LmRlc2NyaXB0aW9uLnRyaW0oKTogJyc7XHJcblx0bGV0IGluZ3JlZGllbnQgPSByZXEuYm9keS5pbmdyZWRpZW50ID8gcmVxLmJvZHkuaW5ncmVkaWVudC50cmltKCk6ICcnO1xyXG5cdGxldCBkaXJlY3Rpb24gPSByZXEuYm9keS5kaXJlY3Rpb24/IHJlcS5ib2R5LmRpcmVjdGlvbi50cmltKCk6ICcnO1xyXG5cclxuXHQvLyBjb25zb2xlLmxvZyh1c2VySWQpXHJcblx0cmV0dXJuIFJlY2lwZVxyXG5cdFx0LmNyZWF0ZSh7XHJcblx0XHRcdHVzZXJJZCxcclxuXHRcdFx0dGl0bGUsXHJcblx0XHRcdGRlc2NyaXB0aW9uLFxyXG5cdFx0XHRpbmdyZWRpZW50LFxyXG5cdFx0XHRkaXJlY3Rpb24sXHJcblx0XHR9KVxyXG5cdFx0LnRoZW4ocmVjaXBlID0+IHJlcy5zdGF0dXMoMjAxKVxyXG5cdFx0XHQuanNvbih7c3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ3JlY2lwZSBjcmVhdGVkIHN1Y2Nlc3NmdWxseScsIHJlY2lwZX0pKVxyXG5cdFx0LmNhdGNoKCAoZXJyKSA9PiByZXMuc3RhdHVzKDUwMCkuanNvbih7c3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6IGVycn0pXHJcblx0XHQpO1xyXG59O1xyXG5cclxuLy8gbW9kaWZ5IGEgcmVjaXBlXHJcbmV4cG9ydCBjb25zdCBtb2RpZnlSZWNpcGUgPSAocmVxLCByZXMpID0+IHtcclxuXHRjb25zdCB7IHVzZXJJZCB9ID0gcmVxO1xyXG5cdGNvbnN0IHsgcmVjaXBlSWQgfSA9IHJlcS5wYXJhbXM7XHJcblx0XHJcblx0cmV0dXJuIFJlY2lwZVxyXG5cdFx0LmZpbmRCeUlkKHJlY2lwZUlkKVxyXG5cdFx0LnRoZW4oIHJlY2lwZSA9PiB7XHJcblx0XHRcdGlmIChyZWNpcGUudXNlcklkICE9PSB1c2VySWQpIHtcclxuXHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDMpLmpzb24oe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnTm90IGF1dGhvcml6ZWQgdG8gbW9kaWZ5IHRoaXMgcmVjaXBlISd9KTtcclxuXHRcdFx0fVxyXG5cdFx0XHRyZXR1cm4gcmVjaXBlXHJcblx0XHRcdFx0LnVwZGF0ZSh7XHJcblx0XHRcdFx0XHR0aXRsZTogcmVxLmJvZHkudGl0bGUgfHwgcmVjaXBlLnRpdGxlLFxyXG5cdFx0XHRcdFx0ZGVzY3JpcHRpb246IHJlcS5ib2R5LmRlc2NyaXB0aW9uIHx8IHJlY2lwZS5kZXNjcmlwdGlvbixcclxuXHRcdFx0XHRcdGluZ3JlZGllbnQ6IHJlcS5ib2R5LmluZ3JlZGllbnQgfHwgcmVjaXBlLmluZ3JlZGllbnQsXHJcblx0XHRcdFx0XHRkaXJlY3Rpb246IHJlcS5ib2R5LmRpcmVjdGlvbiB8fCByZWNpcGUuZGlyZWN0aW9uLFxyXG5cdFx0XHRcdH0pXHJcblx0XHRcdFx0LnRoZW4oIHJlY2lwZSA9PiByZXMuc3RhdHVzKDIwMCkuanNvbih7c3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogJ3JlY2lwZSB1cGRhdGVkIHN1Y2Nlc3NmdWxseScsIHJlY2lwZX0pKVxyXG5cdFx0XHRcdC5jYXRjaCggKCkgPT4gcmVzLnN0YXR1cyg0MDApLmpzb24oe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnRXJyb3IgbW9kaWZ5aW5nIHJlY2lwZSd9KSk7XHJcblx0XHR9KVxyXG5cdFx0LmNhdGNoKCAoKSA9PiByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcblx0XHRcdHN1Y2Nlc3M6IGZhbHNlLFxyXG5cdFx0XHRtZXNzYWdlOiAnRXJyb3IgbW9kaWZ5aW5nIHJlY2lwZSEnXHJcblx0XHR9KSk7XHJcbn07XHJcblx0XHJcblxyXG5leHBvcnQgY29uc3QgZGVsZXRlUmVjaXBlID0gKHJlcSwgcmVzKSA9PiB7XHJcblx0Y29uc3Qge3VzZXJJZH0gPSByZXE7XHJcblx0Ly8gY29uc29sZS5sb2codXNlcklkKTtcclxuXHRSZWNpcGVcclxuXHRcdC5maW5kQnlJZChyZXEucGFyYW1zLnJlY2lwZUlkKVxyXG5cdFx0LnRoZW4oIHJlY2lwZSA9PiB7XHJcblx0XHRcdGlmIChyZWNpcGUudXNlcklkICE9PSAgdXNlcklkKSB7XHJcblx0XHRcdFx0cmV0dXJuIHJlcy5zdGF0dXMoNDAzKS5qc29uKHtzdWNjZXNzOiBmYWxzZSwgbWVzc2FnZTogJ05vdCBhdXRob3JpemVkIHRvIGRlbGV0ZSB0aGlzIHJlY2lwZSd9KTtcclxuXHRcdFx0fVxyXG5cdFx0XHRyZWNpcGVcclxuXHRcdFx0XHQuZGVzdHJveSgpXHJcblx0XHRcdFx0LnRoZW4oICgpID0+IHJlcy5zdGF0dXMoMjAwKS5qc29uKHtzdWNlc3M6IHRydWUsIG1lc3NhZ2U6ICdSZWNpcGUgZGVsZXRlZCBzdWNjZXNzZnVsbHknfSkpXHJcblx0XHRcdFx0LmNhdGNoKCAoKSA9PiByZXMuc3RhdHVzKDQwMCkuanNvbih7c3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6ICdSZWNpcGUgY2Fubm90IGJlIGRlbGV0ZWQnfSkpO1xyXG5cdFx0fSlcclxuXHRcdC5jYXRjaCggKCkgPT4gcmVzLnN0YXR1cyg1MDApLmpzb24oe1xyXG5cdFx0XHRzdWNjZXNzOiBmYWxzZSwgXHJcblx0XHRcdG1lc3NhZ2U6ICdFcnJvciBkZWxldGluZyByZWNpcGUhJ1xyXG5cdFx0fSkpO1xyXG59O1xyXG5cclxuXHJcblxyXG4iXX0=