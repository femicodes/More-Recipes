'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.countVote = exports.voteRecipe = undefined;

var _models = require('../models');

var _models2 = _interopRequireDefault(_models);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Vote = _models2.default.Vote,
    Recipe = _models2.default.Recipe;

// upvote a recipe
// POST --> users/upvote/:recipeId

var voteRecipe = exports.voteRecipe = function voteRecipe(req, res, next) {
	var recipeId = parseInt(req.params.recipeId);

	var voteType = req.params.voteType;
	var userId = req.userId;


	if (voteType !== 'down' && voteType !== 'up') return res.status(400).send({
		success: false,
		message: 'invalid vote type'
	});

	Recipe.findById(recipeId).then(function (recipe) {
		if (recipe.userId === userId) return res.status(200).json({ success: false, message: 'Cant vote on own recipe' });
	});

	// store upvotes as true and downvote as false --> basically convert vote to boolean
	// stores true when upvote and false when downvote
	var voteCond = voteType === 'up' ? true : false;
	Vote.findAll({
		where: {
			recipeId: recipeId
		}
	}).then(function (votes) {

		var alreadyVoted = votes.map(function (v) {
			return v.userId;
		});
		if (alreadyVoted.includes(userId)) {

			var userVote = votes.filter(function (v) {
				return v.userId = userId;
			})[0];
			// console.log(userVote);
			// console.log(`User vote type -----> ${typeof userVote.dataValues.voteType}`);

			// console.log(userVote.dataValues.VoteType === voteCond);

			if (userVote.dataValues.voteType === voteCond) {
				return Vote.findById(userVote.id).then(function (vote) {
					return vote.destroy().then(function () {

						next();
					});
				});
				// .catch( () => res.status(500).json({success: false, message: 'Error'})));
			}

			return Vote.findById(userVote.id).then(function (vote) {
				return vote.update({
					voteType: voteCond
				}).then(function () {
					// res.status(200).json({success: true, message:`${voteType}vote have been recorded successfully`});
					next();
				});
			});
		}
		// .catch();

		return Vote.create({ recipeId: recipeId, userId: userId, voteType: voteCond }).then(function () {
			// res.status(200).json({success: true, message: `${voteType}vote has been recorded successfully`});
			next();
		});
		// .catch( (err) => res.status(500).json({success: false, message: err}));
	});
	// .catch( () =>  res.status(500).json({success: false, message: 'cannot vote recipe'}));
};

// count vote ! 
var countVote = exports.countVote = function countVote(req, res) {
	var recipeId = parseInt(req.params.recipeId);
	// console.log(recipeId);

	Vote.findAll({
		where: {
			recipeId: recipeId
		}
	}).then(function (votes) {
		// console.log(votes);
		var upvoteCount = votes.filter(function (vote) {
			return vote.voteType === true;
		}).length;
		var downvoteCount = votes.filter(function (vote) {
			return vote.voteType === false;
		}).length;
		// console.log(upvoteCount, downvoteCount);

		Recipe.findById(recipeId).then(function (recipe) {
			return recipe.update({ upvoteCount: upvoteCount, downvoteCount: downvoteCount }).then(function (updatedRecipe) {
				res.status(200).json({ success: true,
					updatedRecipe: updatedRecipe
				});
			});
		});
	}).catch(function () {
		return res.status(500).json({ success: false, message: 'cant vote recipe' });
	});

	// return { upvoteCount, downvoteCount };
	// .catch( (err) => res.status(500).json({success: false, message: err}));
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZvdGVzLmpzIl0sIm5hbWVzIjpbIlZvdGUiLCJSZWNpcGUiLCJ2b3RlUmVjaXBlIiwicmVxIiwicmVzIiwibmV4dCIsInJlY2lwZUlkIiwicGFyc2VJbnQiLCJwYXJhbXMiLCJ2b3RlVHlwZSIsInVzZXJJZCIsInN0YXR1cyIsInNlbmQiLCJzdWNjZXNzIiwibWVzc2FnZSIsImZpbmRCeUlkIiwidGhlbiIsInJlY2lwZSIsImpzb24iLCJ2b3RlQ29uZCIsImZpbmRBbGwiLCJ3aGVyZSIsImFscmVhZHlWb3RlZCIsInZvdGVzIiwibWFwIiwidiIsImluY2x1ZGVzIiwidXNlclZvdGUiLCJmaWx0ZXIiLCJkYXRhVmFsdWVzIiwiaWQiLCJ2b3RlIiwiZGVzdHJveSIsInVwZGF0ZSIsImNyZWF0ZSIsImNvdW50Vm90ZSIsInVwdm90ZUNvdW50IiwibGVuZ3RoIiwiZG93bnZvdGVDb3VudCIsInVwZGF0ZWRSZWNpcGUiLCJjYXRjaCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOzs7Ozs7SUFFUUEsSSxvQkFBQUEsSTtJQUFNQyxNLG9CQUFBQSxNOztBQUVkO0FBQ0E7O0FBRU8sSUFBTUMsa0NBQWEsU0FBYkEsVUFBYSxDQUFDQyxHQUFELEVBQU1DLEdBQU4sRUFBV0MsSUFBWCxFQUFvQjtBQUM3QyxLQUFNQyxXQUFXQyxTQUFTSixJQUFJSyxNQUFKLENBQVdGLFFBQXBCLENBQWpCOztBQUQ2QyxLQUdyQ0csUUFIcUMsR0FHeEJOLElBQUlLLE1BSG9CLENBR3JDQyxRQUhxQztBQUFBLEtBSXRDQyxNQUpzQyxHQUk1QlAsR0FKNEIsQ0FJdENPLE1BSnNDOzs7QUFPN0MsS0FBS0QsYUFBYSxNQUFiLElBQXVCQSxhQUFhLElBQXpDLEVBQ0MsT0FBT0wsSUFBSU8sTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCO0FBQzNCQyxXQUFTLEtBRGtCO0FBRTNCQyxXQUFTO0FBRmtCLEVBQXJCLENBQVA7O0FBS0RiLFFBQ0VjLFFBREYsQ0FDV1QsUUFEWCxFQUVFVSxJQUZGLENBRVEsa0JBQVU7QUFDaEIsTUFBSUMsT0FBT1AsTUFBUCxLQUFrQkEsTUFBdEIsRUFDQyxPQUFPTixJQUFJTyxNQUFKLENBQVcsR0FBWCxFQUFnQk8sSUFBaEIsQ0FBcUIsRUFBQ0wsU0FBUyxLQUFWLEVBQWlCQyxTQUFTLHlCQUExQixFQUFyQixDQUFQO0FBQ0QsRUFMRjs7QUFPQTtBQUNBO0FBQ0EsS0FBTUssV0FBV1YsYUFBYSxJQUFiLEdBQW9CLElBQXBCLEdBQTBCLEtBQTNDO0FBQ0FULE1BQ0VvQixPQURGLENBQ1U7QUFDUkMsU0FBTztBQUNOZjtBQURNO0FBREMsRUFEVixFQU1FVSxJQU5GLENBTVEsaUJBQVM7O0FBRWYsTUFBTU0sZUFBZUMsTUFBTUMsR0FBTixDQUFXO0FBQUEsVUFBS0MsRUFBRWYsTUFBUDtBQUFBLEdBQVgsQ0FBckI7QUFDQSxNQUFLWSxhQUFhSSxRQUFiLENBQXNCaEIsTUFBdEIsQ0FBTCxFQUFxQzs7QUFFcEMsT0FBTWlCLFdBQVdKLE1BQU1LLE1BQU4sQ0FBYTtBQUFBLFdBQUtILEVBQUVmLE1BQUYsR0FBV0EsTUFBaEI7QUFBQSxJQUFiLEVBQXNDLENBQXRDLENBQWpCO0FBQ0E7QUFDQTs7QUFFQTs7QUFFQSxPQUFJaUIsU0FBU0UsVUFBVCxDQUFvQnBCLFFBQXBCLEtBQWlDVSxRQUFyQyxFQUErQztBQUM5QyxXQUFPbkIsS0FDTGUsUUFESyxDQUNJWSxTQUFTRyxFQURiLEVBRUxkLElBRkssQ0FFQztBQUFBLFlBQVFlLEtBQ2JDLE9BRGEsR0FFYmhCLElBRmEsQ0FFUCxZQUFNOztBQUVaWDtBQUNBLE1BTGEsQ0FBUjtBQUFBLEtBRkQsQ0FBUDtBQVFBO0FBQ0E7O0FBRUQsVUFBT0wsS0FDTGUsUUFESyxDQUNJWSxTQUFTRyxFQURiLEVBRUxkLElBRkssQ0FFQztBQUFBLFdBQVFlLEtBQUtFLE1BQUwsQ0FBWTtBQUMxQnhCLGVBQVVVO0FBRGdCLEtBQVosRUFFWkgsSUFGWSxDQUVOLFlBQU07QUFDZDtBQUNBWDtBQUNBLEtBTGMsQ0FBUjtBQUFBLElBRkQsQ0FBUDtBQVFBO0FBQ0Q7O0FBRUEsU0FBT0wsS0FDTGtDLE1BREssQ0FDRSxFQUFDNUIsa0JBQUQsRUFBV0ksY0FBWCxFQUFtQkQsVUFBVVUsUUFBN0IsRUFERixFQUVMSCxJQUZLLENBRUMsWUFBTTtBQUNaO0FBQ0FYO0FBQ0EsR0FMSyxDQUFQO0FBTUE7QUFDQSxFQS9DRjtBQWdEQTtBQUNBLENBeEVNOztBQTJFUDtBQUNPLElBQU04QixnQ0FBWSxTQUFaQSxTQUFZLENBQUNoQyxHQUFELEVBQU1DLEdBQU4sRUFBYztBQUN0QyxLQUFNRSxXQUFXQyxTQUFTSixJQUFJSyxNQUFKLENBQVdGLFFBQXBCLENBQWpCO0FBQ0E7O0FBRUFOLE1BQ0VvQixPQURGLENBQ1U7QUFDUkMsU0FBTztBQUNOZixhQUFVQTtBQURKO0FBREMsRUFEVixFQU1FVSxJQU5GLENBTVEsaUJBQVM7QUFDZjtBQUNBLE1BQU1vQixjQUFjYixNQUFNSyxNQUFOLENBQWM7QUFBQSxVQUFRRyxLQUFLdEIsUUFBTCxLQUFrQixJQUExQjtBQUFBLEdBQWQsRUFBOEM0QixNQUFsRTtBQUNBLE1BQU1DLGdCQUFnQmYsTUFBTUssTUFBTixDQUFjO0FBQUEsVUFBUUcsS0FBS3RCLFFBQUwsS0FBa0IsS0FBMUI7QUFBQSxHQUFkLEVBQStDNEIsTUFBckU7QUFDQTs7QUFFQXBDLFNBQ0VjLFFBREYsQ0FDV1QsUUFEWCxFQUVFVSxJQUZGLENBRVE7QUFBQSxVQUFVQyxPQUFPZ0IsTUFBUCxDQUFjLEVBQUNHLHdCQUFELEVBQWFFLDRCQUFiLEVBQWQsRUFDZnRCLElBRGUsQ0FDVCx5QkFBaUI7QUFDdkJaLFFBQUlPLE1BQUosQ0FBVyxHQUFYLEVBQWdCTyxJQUFoQixDQUFxQixFQUFFTCxTQUFTLElBQVg7QUFDcEIwQjtBQURvQixLQUFyQjtBQUdBLElBTGUsQ0FBVjtBQUFBLEdBRlI7QUFTQSxFQXJCRixFQXNCRUMsS0F0QkYsQ0FzQlM7QUFBQSxTQUFNcEMsSUFBSU8sTUFBSixDQUFXLEdBQVgsRUFBZ0JPLElBQWhCLENBQXFCLEVBQUNMLFNBQVMsS0FBVixFQUFpQkMsU0FBUyxrQkFBMUIsRUFBckIsQ0FBTjtBQUFBLEVBdEJUOztBQXdCQTtBQUNBO0FBRUEsQ0EvQk0iLCJmaWxlIjoidm90ZXMuanMiLCJzb3VyY2VSb290IjoiQzovVXNlcnMvVG9iaS9Nb3JlLVJlY2lwZXMvc2VydmVyL2NvbnRyb2xsZXIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgZGIgZnJvbSAnLi4vbW9kZWxzJztcclxuXHJcbmNvbnN0IHsgVm90ZSwgUmVjaXBlIH0gPSBkYjtcclxuXHJcbi8vIHVwdm90ZSBhIHJlY2lwZVxyXG4vLyBQT1NUIC0tPiB1c2Vycy91cHZvdGUvOnJlY2lwZUlkXHJcblxyXG5leHBvcnQgY29uc3Qgdm90ZVJlY2lwZSA9IChyZXEsIHJlcywgbmV4dCkgPT4ge1xyXG5cdGNvbnN0IHJlY2lwZUlkID0gcGFyc2VJbnQocmVxLnBhcmFtcy5yZWNpcGVJZCk7XHJcblxyXG5cdGNvbnN0IHsgdm90ZVR5cGUgfSA9IHJlcS5wYXJhbXM7XHJcblx0Y29uc3Qge3VzZXJJZH0gPSByZXE7XHJcblxyXG5cclxuXHRpZiAoIHZvdGVUeXBlICE9PSAnZG93bicgJiYgdm90ZVR5cGUgIT09ICd1cCcgKSBcclxuXHRcdHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZCh7XHJcblx0XHRcdHN1Y2Nlc3M6IGZhbHNlLFxyXG5cdFx0XHRtZXNzYWdlOiAnaW52YWxpZCB2b3RlIHR5cGUnXHJcblx0XHR9KTtcclxuXHRcclxuXHRSZWNpcGVcclxuXHRcdC5maW5kQnlJZChyZWNpcGVJZClcclxuXHRcdC50aGVuKCByZWNpcGUgPT4ge1xyXG5cdFx0XHRpZiAocmVjaXBlLnVzZXJJZCA9PT0gdXNlcklkKSBcclxuXHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cygyMDApLmpzb24oe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnQ2FudCB2b3RlIG9uIG93biByZWNpcGUnfSk7XHJcblx0XHR9KTtcclxuXHJcblx0Ly8gc3RvcmUgdXB2b3RlcyBhcyB0cnVlIGFuZCBkb3dudm90ZSBhcyBmYWxzZSAtLT4gYmFzaWNhbGx5IGNvbnZlcnQgdm90ZSB0byBib29sZWFuXHJcblx0Ly8gc3RvcmVzIHRydWUgd2hlbiB1cHZvdGUgYW5kIGZhbHNlIHdoZW4gZG93bnZvdGVcclxuXHRjb25zdCB2b3RlQ29uZCA9IHZvdGVUeXBlID09PSAndXAnID8gdHJ1ZTogZmFsc2U7XHJcblx0Vm90ZVxyXG5cdFx0LmZpbmRBbGwoe1xyXG5cdFx0XHR3aGVyZToge1xyXG5cdFx0XHRcdHJlY2lwZUlkXHJcblx0XHRcdH1cclxuXHRcdH0pXHJcblx0XHQudGhlbiAodm90ZXMgPT4geyBcclxuXHRcdFx0XHJcblx0XHRcdGNvbnN0IGFscmVhZHlWb3RlZCA9IHZvdGVzLm1hcCggdiA9PiB2LnVzZXJJZCk7XHJcblx0XHRcdGlmICggYWxyZWFkeVZvdGVkLmluY2x1ZGVzKHVzZXJJZCkgKSB7XHJcblx0XHRcdFx0XHJcblx0XHRcdFx0Y29uc3QgdXNlclZvdGUgPSB2b3Rlcy5maWx0ZXIodiA9PiB2LnVzZXJJZCA9IHVzZXJJZCApWzBdO1xyXG5cdFx0XHRcdC8vIGNvbnNvbGUubG9nKHVzZXJWb3RlKTtcclxuXHRcdFx0XHQvLyBjb25zb2xlLmxvZyhgVXNlciB2b3RlIHR5cGUgLS0tLS0+ICR7dHlwZW9mIHVzZXJWb3RlLmRhdGFWYWx1ZXMudm90ZVR5cGV9YCk7XHJcblxyXG5cdFx0XHRcdC8vIGNvbnNvbGUubG9nKHVzZXJWb3RlLmRhdGFWYWx1ZXMuVm90ZVR5cGUgPT09IHZvdGVDb25kKTtcclxuXHJcblx0XHRcdFx0aWYgKHVzZXJWb3RlLmRhdGFWYWx1ZXMudm90ZVR5cGUgPT09IHZvdGVDb25kKSB7XHJcblx0XHRcdFx0XHRyZXR1cm4gVm90ZVxyXG5cdFx0XHRcdFx0XHQuZmluZEJ5SWQodXNlclZvdGUuaWQpXHJcblx0XHRcdFx0XHRcdC50aGVuKCB2b3RlID0+IHZvdGVcclxuXHRcdFx0XHRcdFx0XHQuZGVzdHJveSgpXHJcblx0XHRcdFx0XHRcdFx0LnRoZW4oICgpID0+IHtcclxuXHRcdFx0XHRcdFx0XHRcdFxyXG5cdFx0XHRcdFx0XHRcdFx0bmV4dCgpO1xyXG5cdFx0XHRcdFx0XHRcdH0pKTtcclxuXHRcdFx0XHRcdC8vIC5jYXRjaCggKCkgPT4gcmVzLnN0YXR1cyg1MDApLmpzb24oe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnRXJyb3InfSkpKTtcclxuXHRcdFx0XHR9IFxyXG5cclxuXHRcdFx0XHRyZXR1cm4gVm90ZSBcclxuXHRcdFx0XHRcdC5maW5kQnlJZCh1c2VyVm90ZS5pZClcclxuXHRcdFx0XHRcdC50aGVuKCB2b3RlID0+IHZvdGUudXBkYXRlKHtcclxuXHRcdFx0XHRcdFx0dm90ZVR5cGU6IHZvdGVDb25kXHJcblx0XHRcdFx0XHR9KS50aGVuKCAoKSA9PiB7XHJcblx0XHRcdFx0XHRcdC8vIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOmAke3ZvdGVUeXBlfXZvdGUgaGF2ZSBiZWVuIHJlY29yZGVkIHN1Y2Nlc3NmdWxseWB9KTtcclxuXHRcdFx0XHRcdFx0bmV4dCgpO1xyXG5cdFx0XHRcdFx0fSkpO1xyXG5cdFx0XHR9XHJcblx0XHRcdC8vIC5jYXRjaCgpO1xyXG5cdFx0XHRcclxuXHRcdFx0cmV0dXJuIFZvdGVcclxuXHRcdFx0XHQuY3JlYXRlKHtyZWNpcGVJZCwgdXNlcklkLCB2b3RlVHlwZTogdm90ZUNvbmR9KVxyXG5cdFx0XHRcdC50aGVuKCAoKSA9PiB7XHJcblx0XHRcdFx0XHQvLyByZXMuc3RhdHVzKDIwMCkuanNvbih7c3VjY2VzczogdHJ1ZSwgbWVzc2FnZTogYCR7dm90ZVR5cGV9dm90ZSBoYXMgYmVlbiByZWNvcmRlZCBzdWNjZXNzZnVsbHlgfSk7XHJcblx0XHRcdFx0XHRuZXh0KCk7XHJcblx0XHRcdFx0fSk7XHJcblx0XHRcdC8vIC5jYXRjaCggKGVycikgPT4gcmVzLnN0YXR1cyg1MDApLmpzb24oe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiBlcnJ9KSk7XHJcblx0XHR9KTtcclxuXHQvLyAuY2F0Y2goICgpID0+ICByZXMuc3RhdHVzKDUwMCkuanNvbih7c3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6ICdjYW5ub3Qgdm90ZSByZWNpcGUnfSkpO1xyXG59O1xyXG5cclxuXHJcbi8vIGNvdW50IHZvdGUgISBcclxuZXhwb3J0IGNvbnN0IGNvdW50Vm90ZSA9IChyZXEsIHJlcykgPT4ge1xyXG5cdGNvbnN0IHJlY2lwZUlkID0gcGFyc2VJbnQocmVxLnBhcmFtcy5yZWNpcGVJZCk7XHJcblx0Ly8gY29uc29sZS5sb2cocmVjaXBlSWQpO1xyXG5cclxuXHRWb3RlXHJcblx0XHQuZmluZEFsbCh7XHJcblx0XHRcdHdoZXJlOiB7XHJcblx0XHRcdFx0cmVjaXBlSWQ6IHJlY2lwZUlkXHJcblx0XHRcdH1cclxuXHRcdH0pXHJcblx0XHQudGhlbiggdm90ZXMgPT4ge1xyXG5cdFx0XHQvLyBjb25zb2xlLmxvZyh2b3Rlcyk7XHJcblx0XHRcdGNvbnN0IHVwdm90ZUNvdW50ID0gdm90ZXMuZmlsdGVyKCB2b3RlID0+IHZvdGUudm90ZVR5cGUgPT09IHRydWUpLmxlbmd0aDtcclxuXHRcdFx0Y29uc3QgZG93bnZvdGVDb3VudCA9IHZvdGVzLmZpbHRlciggdm90ZSA9PiB2b3RlLnZvdGVUeXBlID09PSBmYWxzZSkubGVuZ3RoO1xyXG5cdFx0XHQvLyBjb25zb2xlLmxvZyh1cHZvdGVDb3VudCwgZG93bnZvdGVDb3VudCk7XHJcblxyXG5cdFx0XHRSZWNpcGVcclxuXHRcdFx0XHQuZmluZEJ5SWQocmVjaXBlSWQpXHJcblx0XHRcdFx0LnRoZW4oIHJlY2lwZSA9PiByZWNpcGUudXBkYXRlKHt1cHZvdGVDb3VudCxkb3dudm90ZUNvdW50fSlcclxuXHRcdFx0XHRcdC50aGVuKCB1cGRhdGVkUmVjaXBlID0+IHtcclxuXHRcdFx0XHRcdFx0cmVzLnN0YXR1cygyMDApLmpzb24oeyBzdWNjZXNzOiB0cnVlLFxyXG5cdFx0XHRcdFx0XHRcdHVwZGF0ZWRSZWNpcGVcclxuXHRcdFx0XHRcdFx0fSk7XHJcblx0XHRcdFx0XHR9KVxyXG5cdFx0XHRcdCk7XHJcblx0XHR9KVxyXG5cdFx0LmNhdGNoKCAoKSA9PiByZXMuc3RhdHVzKDUwMCkuanNvbih7c3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6ICdjYW50IHZvdGUgcmVjaXBlJ30pKTtcclxuXHRcdFx0XHRcclxuXHQvLyByZXR1cm4geyB1cHZvdGVDb3VudCwgZG93bnZvdGVDb3VudCB9O1xyXG5cdC8vIC5jYXRjaCggKGVycikgPT4gcmVzLnN0YXR1cyg1MDApLmpzb24oe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiBlcnJ9KSk7XHJcblxyXG59O1xyXG4iXX0=