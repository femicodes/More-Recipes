'use strict';

Object.defineProperty(exports, "__esModule", {
	value: true
});
exports.deleteRecipe = exports.modifyRecipe = exports.createRecipe = exports.getRecipes = exports.getRecipe = undefined;

var _models = require('../models');

var _models2 = _interopRequireDefault(_models);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var Recipe = _models2.default.Recipe;
// const {Review, User} = db;

// returns all recipes ! 
// GET ---> recipes

var getRecipe = exports.getRecipe = function getRecipe(req, res) {
	var recipeId = parseInt(req.params.recipeId);
	// console.log(recipeId);
	return Recipe.findById(recipeId).then(function (recipe) {
		if (recipe) res.status(200).json(recipe);else res.status(200).json({ success: true, message: 'recipe does not exist' });
	}).catch(function (err) {
		return res.status(404).json({
			success: false,
			message: err.errors[0].message
		});
	});
};

// query ---> start=10, end=20; sort=upvotes&order=ascending
var getRecipes = exports.getRecipes = function getRecipes(req, res) {
	// console.log(req.query.sort, req.query.order);
	var _req$query = req.query,
	    sort = _req$query.sort,
	    order = _req$query.order;


	if (sort && order) {

		// if sort and order exist convert them to lowercase ! 
		sort = sort.toLowerCase();
		order = order.toLowerCase();

		if (sort !== 'upvotes' && sort !== 'downvotes') return res.status(400).json({ success: false, message: 'Cannot sort recipes by ' + sort });

		if (order !== 'ascending' && order !== 'descending') return res.status(400).send({ success: false, message: 'Invalid order, Please use either ascending or descending' });

		var orderCriteria = order === 'ascending' ? 'ASC' : 'DESC';
		var sortCriteria = sort === 'upvotes' ? 'upvoteCount' : 'downvoteCount';

		// else if the order and sort is okay. ! 
		return Recipe.findAll({
			attributes: ['id', 'title', 'description', 'ingredient', 'direction', 'upvoteCount', 'downvoteCount'],
			order: [[sortCriteria, orderCriteria]]
			// include: [
			// 	{ model: Review, as: 'reviews', attributes: ['id', 'body'] },
			// 	{ model: User, attributes: ['id', 'username', 'fullname'] }
			// ]
		}).then(function (recipes) {
			return res.status(200).send({ success: true, recipes: recipes });
		}).catch(function () {
			return res.status(500).send({ success: false, message: 'cant get recipes' });
		});
	}

	// if no query at all, just return all the recipes 
	return Recipe.findAll({
		attributes: ['id', 'title', 'description', 'ingredient', 'direction', 'upvoteCount', 'downvoteCount'],
		order: [['upvoteCount', 'DESC']]
		// include: [
		// 	{ model: Review, as: 'reviews', attributes: ['id', 'body'] },
		// 	{ model: User, attributes: ['id', 'username', 'fullname'] }
		// ]
	}).then(function (recipes) {
		return res.status(200).send({ success: true, recipes: recipes });
	}).catch(function (err) {
		return res.status(404).json({
			success: false,
			message: err.errors[0].message
		});
	});
};

// create a recipe 
var createRecipe = exports.createRecipe = function createRecipe(req, res) {
	var userId = req.userId;
	// const {title, description, ingredient, direction} = req.body;

	var title = req.body.title ? req.body.title.trim() : '';
	var description = req.body.description ? req.body.description.trim() : '';
	var ingredient = req.body.ingredient ? req.body.ingredient.trim() : '';
	var direction = req.body.direction ? req.body.direction.trim() : '';

	// console.log(userId)
	return Recipe.create({
		userId: userId,
		title: title,
		description: description,
		ingredient: ingredient,
		direction: direction
	}).then(function (recipe) {
		return res.status(201).json({ message: 'recipe created successfully', recipe: recipe });
	}).catch(function (err) {
		return res.status(500).json({ success: false, message: err.errors[0].message });
	});
};

// modify a recipe
var modifyRecipe = exports.modifyRecipe = function modifyRecipe(req, res) {
	var userId = req.userId;
	var recipeId = req.params.recipeId;


	return Recipe.findById(recipeId).then(function (recipe) {
		if (recipe.userId !== userId) {
			res.status(403).json({ success: false, message: 'Not authorized to delete this recipe!' });
		}
		return recipe.update({
			title: recipe.body.title || recipe.title,
			description: recipe.body.description || recipe.description,
			ingredient: recipe.body.ingredient || recipe.ingredient,
			direction: recipe.body.direction || recipe.direction
		}).then(function (recipe) {
			return res.status(200).json({ message: 'recipe updated successfully', recipe: recipe });
		}).catch(function () {
			return res.status(400).json({ success: false, message: 'Error modifying recipe' });
		});
	}).catch(function () {
		return res.status(500).json({
			success: false,
			message: 'Error modifying recipe'
		});
	});
};

var deleteRecipe = exports.deleteRecipe = function deleteRecipe(req, res) {
	var userId = req.userId;
	// console.log(userId);

	Recipe.findById(req.params.recipeId).then(function (recipe) {
		if (recipe.userId !== userId) {
			return res.status(404).json({ success: false, message: 'Not authorized to delete this recipe' });
		}
		recipe.destroy().then(function () {
			return res.status(200).json({ sucess: true, message: 'Recipe deleted successfully' });
		}).catch(function () {
			return res.status(400).json({ success: false, message: 'Recipe cannot be deleted' });
		});
	}).catch(function (err) {
		return res.status(500).json({
			success: false,
			message: err.errors[0].message
		});
	});
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInJlY2lwZS5qcyJdLCJuYW1lcyI6WyJSZWNpcGUiLCJnZXRSZWNpcGUiLCJyZXEiLCJyZXMiLCJyZWNpcGVJZCIsInBhcnNlSW50IiwicGFyYW1zIiwiZmluZEJ5SWQiLCJ0aGVuIiwicmVjaXBlIiwic3RhdHVzIiwianNvbiIsInN1Y2Nlc3MiLCJtZXNzYWdlIiwiY2F0Y2giLCJlcnIiLCJlcnJvcnMiLCJnZXRSZWNpcGVzIiwicXVlcnkiLCJzb3J0Iiwib3JkZXIiLCJ0b0xvd2VyQ2FzZSIsInNlbmQiLCJvcmRlckNyaXRlcmlhIiwic29ydENyaXRlcmlhIiwiZmluZEFsbCIsImF0dHJpYnV0ZXMiLCJyZWNpcGVzIiwiY3JlYXRlUmVjaXBlIiwidXNlcklkIiwidGl0bGUiLCJib2R5IiwidHJpbSIsImRlc2NyaXB0aW9uIiwiaW5ncmVkaWVudCIsImRpcmVjdGlvbiIsImNyZWF0ZSIsIm1vZGlmeVJlY2lwZSIsInVwZGF0ZSIsImRlbGV0ZVJlY2lwZSIsImRlc3Ryb3kiLCJzdWNlc3MiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFBQTs7Ozs7O0lBRVFBLE0sb0JBQUFBLE07QUFDUjs7QUFFQTtBQUNBOztBQUVPLElBQU1DLGdDQUFZLFNBQVpBLFNBQVksQ0FBQ0MsR0FBRCxFQUFNQyxHQUFOLEVBQWM7QUFDdEMsS0FBTUMsV0FBV0MsU0FBU0gsSUFBSUksTUFBSixDQUFXRixRQUFwQixDQUFqQjtBQUNBO0FBQ0EsUUFBT0osT0FDTE8sUUFESyxDQUNJSCxRQURKLEVBRUxJLElBRkssQ0FFQyxrQkFBVTtBQUNoQixNQUFJQyxNQUFKLEVBQ0NOLElBQUlPLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQkYsTUFBckIsRUFERCxLQUdDTixJQUFJTyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsRUFBQ0MsU0FBUyxJQUFWLEVBQWdCQyxTQUFTLHVCQUF6QixFQUFyQjtBQUNELEVBUEssRUFRTEMsS0FSSyxDQVFDO0FBQUEsU0FBT1gs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Q0MsWUFBUztBQUZ5QixHQUFyQixDQUFOO0FBQUEsRUFoQkYsQ0FBUDtBQW9CQSxDQXhCTTs7QUEyQkEsSUFBTTBCLHNDQUFlLFNBQWZBLFlBQWUsQ0FBQ3JDLEdBQUQsRUFBTUMsR0FBTixFQUFjO0FBQUEsS0FDbEMwQixNQURrQyxHQUN4QjNCLEdBRHdCLENBQ2xDMkIsTUFEa0M7QUFFekM7O0FBQ0E3QixRQUNFTyxRQURGLENBQ1dMLElBQUlJLE1BQUosQ0FBV0YsUUFEdEIsRUFFRUksSUFGRixDQUVRLGtCQUFVO0FBQ2hCLE1BQUlDLE9BQU9vQixNQUFQLEtBQW1CQSxNQUF2QixFQUErQjtBQUM5QixVQUFPMUIsSUFBSU8sTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLEVBQUNDLFNBQVMsS0FBVixFQUFpQkMsU0FBUyxzQ0FBMUIsRUFBckIsQ0FBUDtBQUNBO0FBQ0RKLFNBQ0UrQixPQURGLEdBRUVoQyxJQUZGLENBRVE7QUFBQSxVQUFNTCxJQUFJTyxNQUFKLENBQVcsR0FBWCxFQUFnQkMsSUFBaEIsQ0FBcUIsRUFBQzhCLFFBQVEsSUFBVCxFQUFlNUIsU0FBUyw2QkFBeEIsRUFBckIsQ0FBTjtBQUFBLEdBRlIsRUFHRUMsS0FIRixDQUdTO0FBQUEsVUFBTVgsSUFBSU8sTUFBSixDQUFXLEdBQVgsRUFBZ0JDLElBQWhCLENBQXFCLEVBQUNDLFNBQVMsS0FBVixFQUFpQkMsU0FBUywwQkFBMUIsRUFBckIsQ0FBTjtBQUFBLEdBSFQ7QUFJQSxFQVZGLEVBV0VDLEtBWEYsQ0FXUTtBQUFBLFNBQU9YLElBQUlPLE1BQUosQ0FBVyxHQUFYLEVBQWdCQyxJQUFoQixDQUFxQjtBQUNsQ0MsWUFBUyxLQUR5QjtBQUVsQ0MsWUFBU0UsSUFBSUMsTUFBSixDQUFXLENBQVgsRUFBY0g7QUFGVyxHQUFyQixDQUFQO0FBQUEsRUFYUjtBQWVBLENBbEJNIiwiZmlsZSI6InJlY2lwZS5qcyIsInNvdXJjZVJvb3QiOiJDOi9Vc2Vycy9Ub2JpL01vcmUtUmVjaXBlcy9zZXJ2ZXIvY29udHJvbGxlciIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBkYiBmcm9tICcuLi9tb2RlbHMnO1xyXG5cclxuY29uc3QgeyBSZWNpcGV9ID0gZGI7XHJcbi8vIGNvbnN0IHtSZXZpZXcsIFVzZXJ9ID0gZGI7XHJcblxyXG4vLyByZXR1cm5zIGFsbCByZWNpcGVzICEgXHJcbi8vIEdFVCAtLS0+IHJlY2lwZXNcclxuXHJcbmV4cG9ydCBjb25zdCBnZXRSZWNpcGUgPSAocmVxLCByZXMpID0+IHtcclxuXHRjb25zdCByZWNpcGVJZCA9IHBhcnNlSW50KHJlcS5wYXJhbXMucmVjaXBlSWQpO1xyXG5cdC8vIGNvbnNvbGUubG9nKHJlY2lwZUlkKTtcclxuXHRyZXR1cm4gUmVjaXBlXHJcblx0XHQuZmluZEJ5SWQocmVjaXBlSWQpXHJcblx0XHQudGhlbiggcmVjaXBlID0+IHtcclxuXHRcdFx0aWYgKHJlY2lwZSlcclxuXHRcdFx0XHRyZXMuc3RhdHVzKDIwMCkuanNvbihyZWNpcGUpO1xyXG5cdFx0XHRlbHNlIFxyXG5cdFx0XHRcdHJlcy5zdGF0dXMoMjAwKS5qc29uKHtzdWNjZXNzOiB0cnVlLCBtZXNzYWdlOiAncmVjaXBlIGRvZXMgbm90IGV4aXN0J30pO1xyXG5cdFx0fSlcclxuXHRcdC5jYXRjaChlcnIgPT4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe1xyXG5cdFx0XHRzdWNjZXNzOiBmYWxzZSxcclxuXHRcdFx0bWVzc2FnZTogZXJyLmVycm9yc1swXS5tZXNzYWdlXHJcblx0XHR9KSk7XHJcbn07XHJcblxyXG5cclxuLy8gcXVlcnkgLS0tPiBzdGFydD0xMCwgZW5kPTIwOyBzb3J0PXVwdm90ZXMmb3JkZXI9YXNjZW5kaW5nXHJcbmV4cG9ydCBjb25zdCBnZXRSZWNpcGVzID0gKHJlcSwgcmVzKSA9PiB7XHJcblx0Ly8gY29uc29sZS5sb2cocmVxLnF1ZXJ5LnNvcnQsIHJlcS5xdWVyeS5vcmRlcik7XHJcblx0bGV0IHtzb3J0LCBvcmRlcn0gPSByZXEucXVlcnk7XHJcblxyXG5cdGlmIChzb3J0ICYmIG9yZGVyKSB7XHJcblxyXG5cdFx0Ly8gaWYgc29ydCBhbmQgb3JkZXIgZXhpc3QgY29udmVydCB0aGVtIHRvIGxvd2VyY2FzZSAhIFxyXG5cdFx0c29ydCA9IHNvcnQudG9Mb3dlckNhc2UoKTsgXHJcblx0XHRvcmRlciA9IG9yZGVyLnRvTG93ZXJDYXNlKCk7XHJcblx0XHRcclxuXHRcdGlmIChzb3J0ICE9PSAndXB2b3RlcycgJiYgc29ydCAhPT0gJ2Rvd252b3RlcycpXHJcblx0XHRcdHJldHVybiByZXMuc3RhdHVzKDQwMCkuanNvbih7c3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6IGBDYW5ub3Qgc29ydCByZWNpcGVzIGJ5ICR7c29ydH1gfSk7XHJcblx0XHRcclxuXHJcblx0XHRpZiAob3JkZXIgIT09ICdhc2NlbmRpbmcnICYmIG9yZGVyICE9PSAnZGVzY2VuZGluZycpXHJcblx0XHRcdHJldHVybiByZXMuc3RhdHVzKDQwMCkuc2VuZCh7c3VjY2VzczogZmFsc2UsIG1lc3NhZ2U6ICdJbnZhbGlkIG9yZGVyLCBQbGVhc2UgdXNlIGVpdGhlciBhc2NlbmRpbmcgb3IgZGVzY2VuZGluZyd9KTtcclxuXHRcdFxyXG5cclxuXHRcdFxyXG5cdFx0Y29uc3Qgb3JkZXJDcml0ZXJpYSA9IG9yZGVyID09PSAnYXNjZW5kaW5nJz8gJ0FTQycgOiAnREVTQyc7XHJcblx0XHRjb25zdCBzb3J0Q3JpdGVyaWEgPSBzb3J0ID09PSAndXB2b3Rlcyc/ICd1cHZvdGVDb3VudCcgOiAnZG93bnZvdGVDb3VudCc7XHJcblxyXG5cdFx0Ly8gZWxzZSBpZiB0aGUgb3JkZXIgYW5kIHNvcnQgaXMgb2theS4gISBcclxuXHRcdHJldHVybiBSZWNpcGVcclxuXHRcdFx0LmZpbmRBbGwoe1xyXG5cdFx0XHRcdGF0dHJpYnV0ZXM6IFsnaWQnLCAndGl0bGUnLCAnZGVzY3JpcHRpb24nLCAnaW5ncmVkaWVudCcsICdkaXJlY3Rpb24nLCAndXB2b3RlQ291bnQnLCAnZG93bnZvdGVDb3VudCddLFxyXG5cdFx0XHRcdG9yZGVyOiBbW3NvcnRDcml0ZXJpYSwgb3JkZXJDcml0ZXJpYV1dLFxyXG5cdFx0XHRcdC8vIGluY2x1ZGU6IFtcclxuXHRcdFx0XHQvLyBcdHsgbW9kZWw6IFJldmlldywgYXM6ICdyZXZpZXdzJywgYXR0cmlidXRlczogWydpZCcsICdib2R5J10gfSxcclxuXHRcdFx0XHQvLyBcdHsgbW9kZWw6IFVzZXIsIGF0dHJpYnV0ZXM6IFsnaWQnLCAndXNlcm5hbWUnLCAnZnVsbG5hbWUnXSB9XHJcblx0XHRcdFx0Ly8gXVxyXG5cdFx0XHR9KVxyXG5cdFx0XHQudGhlbihyZWNpcGVzID0+IHJlcy5zdGF0dXMoMjAwKS5zZW5kKHsgc3VjY2VzczogdHJ1ZSwgcmVjaXBlc30pKVxyXG5cdFx0XHQuY2F0Y2goICgpID0+IHJlcy5zdGF0dXMoNTAwKS5zZW5kKHtzdWNjZXNzOiBmYWxzZSwgbWVzc2FnZTogJ2NhbnQgZ2V0IHJlY2lwZXMnfSkpO1xyXG5cdH1cclxuXHJcblx0Ly8gaWYgbm8gcXVlcnkgYXQgYWxsLCBqdXN0IHJldHVybiBhbGwgdGhlIHJlY2lwZXMgXHJcblx0cmV0dXJuIFJlY2lwZVxyXG5cdFx0LmZpbmRBbGwoe1xyXG5cdFx0XHRhdHRyaWJ1dGVzOiBbJ2lkJywgJ3RpdGxlJywgJ2Rlc2NyaXB0aW9uJywgJ2luZ3JlZGllbnQnLCAnZGlyZWN0aW9uJywgJ3Vwdm90ZUNvdW50JywgJ2Rvd252b3RlQ291bnQnXSxcclxuXHRcdFx0b3JkZXI6IFtbJ3Vwdm90ZUNvdW50JywgJ0RFU0MnXV0sXHJcblx0XHRcdC8vIGluY2x1ZGU6IFtcclxuXHRcdFx0Ly8gXHR7IG1vZGVsOiBSZXZpZXcsIGFzOiAncmV2aWV3cycsIGF0dHJpYnV0ZXM6IFsnaWQnLCAnYm9keSddIH0sXHJcblx0XHRcdC8vIFx0eyBtb2RlbDogVXNlciwgYXR0cmlidXRlczogWydpZCcsICd1c2VybmFtZScsICdmdWxsbmFtZSddIH1cclxuXHRcdFx0Ly8gXVxyXG5cdFx0fSlcclxuXHRcdC50aGVuKHJlY2lwZXMgPT4gcmVzLnN0YXR1cygyMDApLnNlbmQoe3N1Y2Nlc3M6IHRydWUsIHJlY2lwZXMgfSkpXHJcblx0XHQuY2F0Y2goIGVyciA9PiByZXMuc3RhdHVzKDQwNCkuanNvbih7XHJcblx0XHRcdHN1Y2Nlc3M6IGZhbHNlLFxyXG5cdFx0XHRtZXNzYWdlOiBlcnIuZXJyb3JzWzBdLm1lc3NhZ2VcclxuXHRcdH0pKTtcclxufTtcclxuXHJcblxyXG4vLyBjcmVhdGUgYSByZWNpcGUgXHJcbmV4cG9ydCBjb25zdCBjcmVhdGVSZWNpcGUgPSAocmVxLCByZXMpID0+IHtcclxuXHRjb25zdCB7dXNlcklkfSA9IHJlcTtcclxuXHQvLyBjb25zdCB7dGl0bGUsIGRlc2NyaXB0aW9uLCBpbmdyZWRpZW50LCBkaXJlY3Rpb259ID0gcmVxLmJvZHk7XHJcblx0XHJcblx0bGV0IHRpdGxlID0gcmVxLmJvZHkudGl0bGU/IHJlcS5ib2R5LnRpdGxlLnRyaW0oKSA6ICcnO1xyXG5cdGxldCBkZXNjcmlwdGlvbiA9IHJlcS5ib2R5LmRlc2NyaXB0aW9uPyByZXEuYm9keS5kZXNjcmlwdGlvbi50cmltKCk6ICcnO1xyXG5cdGxldCBpbmdyZWRpZW50ID0gcmVxLmJvZHkuaW5ncmVkaWVudCA/IHJlcS5ib2R5LmluZ3JlZGllbnQudHJpbSgpOiAnJztcclxuXHRsZXQgZGlyZWN0aW9uID0gcmVxLmJvZHkuZGlyZWN0aW9uPyByZXEuYm9keS5kaXJlY3Rpb24udHJpbSgpOiAnJztcclxuXHJcblx0Ly8gY29uc29sZS5sb2codXNlcklkKVxyXG5cdHJldHVybiBSZWNpcGVcclxuXHRcdC5jcmVhdGUoe1xyXG5cdFx0XHR1c2VySWQsXHJcblx0XHRcdHRpdGxlLFxyXG5cdFx0XHRkZXNjcmlwdGlvbixcclxuXHRcdFx0aW5ncmVkaWVudCxcclxuXHRcdFx0ZGlyZWN0aW9uLFxyXG5cdFx0fSlcclxuXHRcdC50aGVuKHJlY2lwZSA9PiByZXMuc3RhdHVzKDIwMSlcclxuXHRcdFx0Lmpzb24oe21lc3NhZ2U6ICdyZWNpcGUgY3JlYXRlZCBzdWNjZXNzZnVsbHknLCByZWNpcGV9KSlcclxuXHRcdC5jYXRjaCggKGVycikgPT4gcmVzLnN0YXR1cyg1MDApLmpzb24oe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiBlcnIuZXJyb3JzWzBdLm1lc3NhZ2V9KVxyXG5cdFx0KTtcclxufTtcclxuXHJcbi8vIG1vZGlmeSBhIHJlY2lwZVxyXG5leHBvcnQgY29uc3QgbW9kaWZ5UmVjaXBlID0gKHJlcSwgcmVzKSA9PiB7XHJcblx0Y29uc3QgeyB1c2VySWQgfSA9IHJlcTtcclxuXHRjb25zdCB7IHJlY2lwZUlkIH0gPSByZXEucGFyYW1zO1xyXG5cdFxyXG5cdHJldHVybiBSZWNpcGVcclxuXHRcdC5maW5kQnlJZChyZWNpcGVJZClcclxuXHRcdC50aGVuKCByZWNpcGUgPT4ge1xyXG5cdFx0XHRpZiAocmVjaXBlLnVzZXJJZCAhPT0gdXNlcklkKSB7XHJcblx0XHRcdFx0cmVzLnN0YXR1cyg0MDMpLmpzb24oe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnTm90IGF1dGhvcml6ZWQgdG8gZGVsZXRlIHRoaXMgcmVjaXBlISd9KTtcclxuXHRcdFx0fVxyXG5cdFx0XHRyZXR1cm4gcmVjaXBlXHJcblx0XHRcdFx0LnVwZGF0ZSh7XHJcblx0XHRcdFx0XHR0aXRsZTogcmVjaXBlLmJvZHkudGl0bGUgfHwgcmVjaXBlLnRpdGxlLFxyXG5cdFx0XHRcdFx0ZGVzY3JpcHRpb246IHJlY2lwZS5ib2R5LmRlc2NyaXB0aW9uIHx8IHJlY2lwZS5kZXNjcmlwdGlvbixcclxuXHRcdFx0XHRcdGluZ3JlZGllbnQ6IHJlY2lwZS5ib2R5LmluZ3JlZGllbnQgfHwgcmVjaXBlLmluZ3JlZGllbnQsXHJcblx0XHRcdFx0XHRkaXJlY3Rpb246IHJlY2lwZS5ib2R5LmRpcmVjdGlvbiB8fCByZWNpcGUuZGlyZWN0aW9uLFxyXG5cdFx0XHRcdH0pXHJcblx0XHRcdFx0LnRoZW4oIHJlY2lwZSA9PiByZXMuc3RhdHVzKDIwMCkuanNvbih7bWVzc2FnZTogJ3JlY2lwZSB1cGRhdGVkIHN1Y2Nlc3NmdWxseScsIHJlY2lwZX0pKVxyXG5cdFx0XHRcdC5jYXRjaCggKCkgPT4gcmVzLnN0YXR1cyg0MDApLmpzb24oe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnRXJyb3IgbW9kaWZ5aW5nIHJlY2lwZSd9KSk7XHJcblx0XHR9KVxyXG5cdFx0LmNhdGNoKCAoKSA9PiByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcblx0XHRcdHN1Y2Nlc3M6IGZhbHNlLFxyXG5cdFx0XHRtZXNzYWdlOiAnRXJyb3IgbW9kaWZ5aW5nIHJlY2lwZSdcclxuXHRcdH0pKTtcclxufTtcclxuXHRcclxuXHJcbmV4cG9ydCBjb25zdCBkZWxldGVSZWNpcGUgPSAocmVxLCByZXMpID0+IHtcclxuXHRjb25zdCB7dXNlcklkfSA9IHJlcTtcclxuXHQvLyBjb25zb2xlLmxvZyh1c2VySWQpO1xyXG5cdFJlY2lwZVxyXG5cdFx0LmZpbmRCeUlkKHJlcS5wYXJhbXMucmVjaXBlSWQpXHJcblx0XHQudGhlbiggcmVjaXBlID0+IHtcclxuXHRcdFx0aWYgKHJlY2lwZS51c2VySWQgIT09ICB1c2VySWQpIHtcclxuXHRcdFx0XHRyZXR1cm4gcmVzLnN0YXR1cyg0MDQpLmpzb24oe3N1Y2Nlc3M6IGZhbHNlLCBtZXNzYWdlOiAnTm90IGF1dGhvcml6ZWQgdG8gZGVsZXRlIHRoaXMgcmVjaXBlJ30pO1xyXG5cdFx0XHR9XHJcblx0XHRcdHJlY2lwZVxyXG5cdFx0XHRcdC5kZXN0cm95KClcclxuXHRcdFx0XHQudGhlbiggKCkgPT4gcmVzLnN0YXR1cygyMDApLmpzb24oe3N1Y2VzczogdHJ1ZSwgbWVzc2FnZTogJ1JlY2lwZSBkZWxldGVkIHN1Y2Nlc3NmdWxseSd9KSlcclxuXHRcdFx0XHQuY2F0Y2goICgpID0+IHJlcy5zdGF0dXMoNDAwKS5qc29uKHtzdWNjZXNzOiBmYWxzZSwgbWVzc2FnZTogJ1JlY2lwZSBjYW5ub3QgYmUgZGVsZXRlZCd9KSk7XHJcblx0XHR9KVxyXG5cdFx0LmNhdGNoKGVyciA9PiByZXMuc3RhdHVzKDUwMCkuanNvbih7XHJcblx0XHRcdHN1Y2Nlc3M6IGZhbHNlLCBcclxuXHRcdFx0bWVzc2FnZTogZXJyLmVycm9yc1swXS5tZXNzYWdlXHJcblx0XHR9KSk7XHJcbn07XHJcblxyXG5cclxuXHJcbiJdfQ==